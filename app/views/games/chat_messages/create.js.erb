(function () {
  var form = document.getElementById('new_message')
  form.innerHTML = '<%=
    escape_javascript render('games/chat_messages/form', session: @session, message: ChatMessage.new)
  %>'
  
  var chatSession = document.querySelector('[data-text-chat-game-session-id="<%= @session.id %>"]')
  var attributes  = {
    game_session_id: <%= @session.id %>,
    chat_message_id: <%= @message.id %>,
    html:            '<%=
       escape_javascript render('games/chat_messages/chat_message', chat_message: @message)
    %>'
  }
  
  if (chatSession && window.VTT && window.VTT.application) {
    var app  = window.VTT.application
    var chat = app.getControllerForElementAndIdentifier(chatSession, 'text-chat')
    chat.addMessage(attributes)
  }
})()
